# ShuttleVision 系统高阶设计文档（HLD）

## 1. 背景与目标

### 1.1 项目背景

ShuttleVision 旨在基于单台固定机位的单目视频，对羽毛球飞行进行三维轨迹重建与分析。系统通过几何建模、检测与跟踪、深度估计和物理建模，从原始视频自动产出具有物理意义的三维轨迹和球路分析结果，用于科研和训练分析。

### 1.2 业务目标

- 从单目训练或比赛视频中自动提取羽毛球的 **三维轨迹 $\mathrm{X}(t), \mathrm{Y}(t), \mathrm{Z}(t)$**。
- 计算球速、飞行高度、飞行时间、落点、过网高度等关键物理指标。
- 自动识别常见球路类型（高远、杀球、吊球、平抽等）。
- 提供可视化界面（原视频叠加、俯视/侧视图、多视图轨迹展示）。
- 系统整体具备良好的可扩展性，可作为毕业设计/科研项目的基础平台。

### 1.3 非目标（当前版本）

- 不追求实时在线分析（当前定位为 **离线批处理系统**）。
- 不支持多机位融合（仅支持单台固定相机）。
- 不覆盖复杂 UI 交互（以简单桌面应用或命令行 + 结果文件/简单展示为主）。
- 不解决自动相机标定（仍假设有少量人工标注参与球场几何标定）。

---

## 2. 系统整体架构

### 2.1 顶层视图

系统采用模块化分层架构，从“视频输入”到“可视化输出”形成一条完整的处理流水线：

1. **模块 0：视频解码与预处理（Video I/O）**
2. **模块 1：球场三维坐标系构建（Camera–Court Geometry）**
3. **模块 2：羽毛球检测与像素轨迹生成（Shuttle Detection & 2D Tracking）**
4. **模块 3：像素点转三维射线（Pixel-to-3D Ray Conversion）**
5. **模块 4a：羽毛球区域深度估计（Depth Estimation for Shuttle Region）**
6. **模块 4b：基于物理模型的三维轨迹求解（3D Trajectory Reconstruction with Depth Prior）**
7. **模块 5：轨迹分析与球路识别（Trajectory Analysis & Classification）**
8. **模块 6：可视化与系统界面（Visualization & Front-End）**

各模块之间通过明确的数据结构和文件格式交互，尽量保持解耦和可替换性。

### 2.2 技术栈与关键第三方依赖（规划）

- **语言与运行环境**：Python 3.11
- **包管理**：uv
- **数值计算**：numpy, scipy
- **视频解码**：pyav 或 OpenCV（后端可插拔）
- **深度学习推理**：PyTorch / ONNX Runtime（具体模型待选）
- **可视化**：matplotlib / plotly / simple web front-end（视精力而定）
- **配置与 CLI**：typer / argparse + yaml/toml 配置文件

第三方依赖在 HLD 中只给出方向，具体库在 LLD 和实现阶段再最终确定。

---

## 3. 模块设计（高层）

### 3.1 模块 0：视频解码与预处理（Video I/O）

**职责**：

- 接收用户提供的视频文件，屏蔽封装格式、编码格式和帧率差异。
- 将视频解码为统一格式的逐帧数据流（`ndarray` 图像 + 时间戳 + 帧号）。
- 可选：统一分辨率、统一最大 FPS（下采样），便于后续计算和模型推理。

**输入**：

- 视频文件路径（或文件句柄）。
- 解码配置：目标分辨率、目标 FPS、时间裁剪区间等。

**输出**：

- 流式 `DecodedFrame` 序列：
  - `frame_index: int`
  - `timestamp_s: float`
  - `image: ndarray`（H×W×3, uint8, RGB）
- 视频元数据 `VideoMetadata`：分辨率、时长、编码信息等。

**与其他模块的关系**：

- 为模块 2 提供逐帧图像输入。
- 为标定工具/标定模块提供示例帧截图（用于在该帧上完成球场角点、网柱等标注）。
- 作为系统处理链路的入口，必须保证可流式处理，避免全视频展开占用过多内存。

---

### 3.2 模块 1：球场三维坐标系构建（Camera–Court Geometry）

**职责**：

- 构建标准羽毛球场地的三维坐标系（单位：米）。
- 利用少量人工标注（球场角点、网柱顶点）和已知球场尺寸，估计相机在该坐标系下的姿态（R, t）。
- 提供像素坐标 → 三维射线变换所需的几何信息。

**输入**：

- 标注的像素点：球场四角点、左右网柱顶点等（人工标注或自动标注）。
- 球场标准尺寸参数：场地长、宽、网高等。
- 相机内参（已知/从配置文件读取/简单估计）。

**输出**：

- 球场坐标系定义（原点位置、轴向约定）。
- 相机姿态 `CameraPose`（包含 K、R、t）。
- 标定质量指标（平均重投影误差等）。

**协作关系**：

- 为模块 3 提供相机几何信息，使像素位置可被转换为具有物理意义的三维方向射线。
- 标定可在系统运行前离线完成，也可在主流程开始前执行一次。
- 标注像素点通常由“标定工具”基于模块 0 抽取的一帧示例图像生成；模块 1 不直接处理图像，只消费标注结果和球场几何参数。
- 当前版本假设输入视频已完成基础去畸变，模块 1 和模块 3 采用简化的针孔相机模型进行几何建模；在 `CameraIntrinsics` 等相机建模结构中预留畸变参数字段，未来接入运动相机等畸变明显的视频源时，可以在不破坏整体架构的前提下扩展为包含畸变的相机模型。

---

### 3.3 模块 2：羽毛球检测与像素轨迹生成（Shuttle Detection & 2D Tracking）

**职责**：

- 从每帧图像中检测羽毛球候选位置（小目标检测），允许同一帧内出现多个羽毛球目标。
- 将逐帧检测结果通过时序关联和滤波，生成一条或多条平滑、连续的 2D 像素轨迹（多目标跟踪）。
- 利用简单的规则对检测结果和轨迹进行筛选，尽量剔除明显不可能是羽毛球的目标或轨迹。
- 为上游几何/物理建模模块提供稳定、带 Track ID 的 2D 观测序列。

**输入**：

- 模块 0 解码出来的逐帧图像流（含 `frame_index` 与 `timestamp`）。

**输出**：

- 羽毛球像素位置序列 $u_t, v_t$，附带：
  - 时间戳 $\text{timestamp}_t$
  - 置信度 $\text{score}_t$
  - 所属轨迹 ID（实际场景可能同时存在多条轨迹，Track ID 用于区分不同羽毛球目标）。

**方法（高层）**：

- 使用轻量检测模型（如 YOLO、TrackNet 变体）输出候选位置（可能多于一个候选）。
- 在检测阶段应用一层规则过滤，对候选目标按尺寸、长宽比、亮度/纹理特征、与球场区域的相对位置等进行快速筛选，剔除明显不符合羽毛球外观/大小的候选（如大面积物体、长期静止的高亮点等）。
- 使用卡尔曼滤波或简单运动模型进行多目标跟踪与轨迹平滑，对不同羽毛球目标分配不同的 Track ID。
- 在跟踪阶段继续施加规则约束，例如速度/加速度范围、轨迹连续性、与球场范围的空间关系等，对不合理的轨迹进行降权或直接丢弃，从而进一步过滤误检。
- 输出统一的数据结构 `Track2D`（列表形式），其中每条轨迹携带唯一的 Track ID，供后续模块使用；同时保留“主轨迹选择策略”的挂钩（例如根据轨迹存在时间、连续性、物理合理性等由后续模块或规则确定）。

**协作关系**：

- 为模块 3 提供 $u_t, v_t$ 像素轨迹，是整条流水线的数据起点之一。
- 为深度估计模块提供羽毛球附近的裁剪区域（通过 bbox）。

---

### 3.4 模块 3：像素点转三维射线（Pixel-to-3D Ray Conversion）

**职责**：

- 根据模块 1 的相机几何和模块 2 的像素轨迹，将每个 $u_t, v_t$ 转换为世界坐标系下的三维射线。

**输入**：

- 模块 1 输出的相机姿态（内外参）。
- 模块 2 输出的 2D 轨迹。

**输出**：

- 对应每一帧的三维射线：
  - 射线起点：相机光心在球场坐标系下的位置。
  - 射线方向：归一化三维向量。

**协作关系**：

- 为轨迹重建模块（模块 4）提供几何约束：羽毛球必须位于该射线上。
- 为深度估计模块提供“射线方向”，以便将深度标量转为三维位置。

---

### 3.5 模块 4a：羽毛球区域深度估计（Depth Estimation for Shuttle Region）

**职责**：

- 为当前机位/场地生成可复用的静态场景深度场（全局深度图）。
- 基于静态深度场 + 局部图像 + 运动信息，对羽毛球邻域做精细深度估计。
- 为每一帧羽毛球位置提供“沿射线方向的深度先验”和置信度，用于后续三维轨迹优化。

**输入**：

- 模块 2 的羽毛球 bbox。
- 模块 3 的射线方向（可选）。
- 原始帧图像或局部裁剪图像。

**输出**：

- 每一帧的深度估计值（例如：到相机的距离或沿射线方向的标量）。
- 深度置信度估计（可选）。

**方法（高层）**：

- 在“背景整体基本不变、相机固定”的前提下，先对场景生成一份较稳定的全局深度估计（静态场景深度图）。
- 在此基础上，围绕羽毛球区域进行二次深度精细估计：利用原始图像补丁 + 对应的深度补丁 + 运动信息，得到更准确的局部深度先验。

**TODO：**

- 单目深度的全局尺度与真实物理尺度的对齐策略尚未固定，候选方案包括「几何约束标定」与「仅用作相对先验」。

**协作关系**：

- 与模块 3 的射线结合，得到每帧羽毛球初始三维位置估计。
- 为模块 4b（轨迹重建）提供更好的初值和约束，提升优化稳定性。

---

### 3.6 模块 4b：基于物理模型的三维轨迹求解（3D Trajectory Reconstruction with Depth Prior）

**职责**：

- 综合几何射线约束、深度先验和物理模型，对羽毛球整个飞行过程进行三维轨迹求解与平滑。

**输入**：

- 模块 3 输出的射线序列。
- 深度估计模块输出的深度先验序列。
- 时间戳序列（来自模块 2/模块 0）。

**输出**：

- 连续、平滑、物理一致的三维轨迹 $\mathrm{X}(t), \mathrm{Y}(t), \mathrm{Z}(t)$。

**方法（高层）**：

- 根据射线 + 深度先验计算每帧的初始三维位置。
- 构造时间序列优化问题：
  - 几何一致性（点必须接近对应射线）。
  - 深度先验一致性。
  - 物理平滑性约束（速度/加速度连续，弱重力趋势等）。
- 使用非线性最小二乘或其他优化方法求解。

**协作关系**：

- 为模块 5 提供最终的三维轨迹。
- 为模块 6 的可视化提供核心数据源。

---

### 3.7 模块 5：轨迹分析与球路识别（Trajectory Analysis & Classification）

**职责**：

- 对三维轨迹进行分析，计算物理量并识别球路类型。

**输入**：

- 模块 4 输出的三维轨迹（带时间轴）。

**输出**：

- 关键物理量：
  - 瞬时速度、平均速度、最大速度。
  - 最高点、最低点、过网高度。
  - 起点/落点坐标等。
- 球路类型标签（高远球、杀球、吊球等）。
- 关键事件点（击球点、落地点等）的时间和空间坐标。

**方法（高层）**：

- 对轨迹进行数值微分与统计分析。
- 提取轨迹形状特征（高度变化曲线、速度变化模式）。
- 使用规则/阈值逻辑或轻量分类模型进行球路分类。

**协作关系**：

- 向模块 6 提供结构化数据，用于可视化与展示。
- 结果可输出为 JSON/CSV 供进一步科研分析或论文使用。

---

### 3.8 模块 6：可视化与系统界面（Visualization & Front-End）

**职责**：

- 将检测轨迹、三维轨迹和分析结果以用户友好的方式展示给使用者。

**输入**：

- 模块 2 的像素轨迹。
- 模块 4b 的三维轨迹。
- 模块 5 的物理量与球路分类结果。

**输出**：

- 视频叠加轨迹（在原视频帧上绘制羽毛球路径）。
- 俯视图/侧视图的三维轨迹投影图。
- 数据面板：展示速度、落点、球路类型等指标。

**形态（候选方案）**：

- 简单桌面应用（PyQt/Qt for Python）。
- 轻量 web 前端（FastAPI/Flask + 前端页面）。
- 命令行 + 生成 HTML/图像文件。

**协作关系**：

- 作为系统的最终展示层，聚合所有上游模块的输出。

---

## 4. 数据流与控制流

### 4.1 数据流概览

1. 用户提供视频文件和标定信息（或进入标定流程）。
2. 模块 0 解码视频，输出逐帧 DecodedFrame 流。
3. 模块 2 读取帧流，运行检测与跟踪，输出 2D 轨迹。
4. 模块 1 利用标注数据和球场参数完成标定，输出相机姿态。
5. 模块 3 利用相机姿态 + 2D 轨迹，输出射线序列。
6. 深度估计模块先对场景生成静态深度场，再基于局部图像 + 运动信息做羽毛球局部深度精细估计，输出每帧的深度先验。
7. 模块 4b 将射线 + 深度先验 + 时间信息整合，优化出三维轨迹。
8. 模块 5 解析三维轨迹，计算物理指标与球路类型。
9. 模块 6 将所有结果进行可视化展示或导出。

### 4.2 控制流与运行模式

- **离线批处理模式（主模式）**：

  - 用户通过命令行或简单 UI 选择视频文件和配置。
  - 系统顺序执行模块 0 → 2 → 1/3/深度 → 4 → 5 → 6。
  - 中间结果（检测结果、轨迹、分析指标）可选择落盘，用于调试或复用。

- **调试/开发模式**：

  - 支持只跑某些阶段（例如只跑检测 + 跟踪），检查效果。
  - 支持将中间结果导出为可视化图像、JSON/CSV。

---

## 5. 外部接口与配置

### 5.1 对用户/调用者的外部接口

- **CLI 接口**：

  - `shuttlevision run --video path/to.mp4 --config config.yaml`
  - 可选参数：输出目录、是否保存中间结果、是否启用可视化等。

- **配置文件**：

  - 包含：
    - 视频解码参数（目标分辨率、FPS）。
    - 标定参数（场地类型、网高度、标注文件路径）。
    - 模型权重路径（检测、深度估计）。
    - 轨迹优化与分析的超参数。

- **输出文件格式**（候选）：

  - 2D 轨迹：JSON/CSV。
  - 3D 轨迹：CSV/npz。
  - 分析结果：JSON/CSV。
  - 可视化结果：PNG/MP4/HTML。

### 5.2 对第三方组件的接口

- 模型加载接口：统一封装模型推理（检测、深度估计），对外以简单函数形式暴露。
- 视频解码后端：通过抽象接口支持切换 PyAV/OpenCV 等实现。

---

## 6. 质量属性与设计考量

### 6.1 性能与可扩展性

- 单机离线处理为主，核心瓶颈在视频解码和模型推理。
- 通过流式解码和适度的分辨率/FPS 下采样平衡精度与性能。
- 模块化设计允许替换模型或优化算法，而不影响整体架构。

### 6.2 可维护性与可测试性

- 各模块有清晰输入/输出接口，便于单元测试和集成测试。
- 重视中间结果的可视化和导出，方便调试。
- 使用类型标注和结构化配置，降低维护成本。

### 6.3 可移植性与环境要求

- 以 Python 为主，依赖 FFmpeg/PyAV 或 OpenCV，目标环境为常见桌面/服务器。
- GPU 加速是可选增强项，不作为架构强依赖。

---

## 7. 风险与待决问题

### 7.1 技术风险

- 单目深度估计的误差可能导致三维轨迹偏差，需要物理约束和后处理来缓解。
- 羽毛球作为小目标，在某些场景下检测难度较大（模糊、遮挡、曝光问题）。
- 相机标定的精度对整体效果影响较大，标注工具和流程需要设计得足够易用和稳健。

### 7.2 工程风险

- 第三方库（视频解码、深度模型）的兼容性与维护问题。
- 训练或微调深度学习模型所需的数据量和标注成本。

### 7.3 待决问题

- 前端形态最终选择：桌面应用 vs web 前端。
- 深度估计模块是完全基于现有模型还是需要自训练模型。
- 是否在首个版本中支持多段视频批处理和简单的批量报告生成功能。

---

## 8. 与软件设计流程的关系

- 当前文档属于 **高阶设计（HLD）阶段产物**：

  - 定义了系统模块划分、协作方式和技术路线。
  - 给出了整体数据流与控制流。
  - 指明了关键风险和待决问题。

- 下一步工作：

  - 针对核心模块（特别是模块 0/1/2/3），编写详细设计（LLD），包括：
    - 类、函数、数据结构设计。
    - 关键算法选择与伪代码。
    - 错误处理策略和日志方案。
  - 在 LLD 基础上启动编码与单元测试编写。